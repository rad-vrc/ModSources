using Terraria;
using Terraria.ModLoader;

namespace TranslateTest2
{
    public class PrefixGlobalItem : GlobalItem
    {
        public float MinionSlotMult = 1f;
        public float MinionSpeedMult = 1f;
        public float MinionScaleMult = 1f;
        public float MinionKnockbackMult = 1f;
        public float MinionLifeSteal = 0f;
        public float MinionCritAdd = 0f;
        public float MinionUpdateSpeed = 1f;
        public float WhipRangeMult = 1f;
        public bool CanGiveTag = false;
        public WhipTag wTag = null;
        
        // Original SummonerPrefix properties
        public bool electrified = false;
        public bool blessing = false;

        public override bool InstancePerEntity => true;

        public override GlobalItem Clone(Item from, Item to)
        {
            PrefixGlobalItem myClone = (PrefixGlobalItem)base.Clone(from, to);
            myClone.wTag = wTag?.Clone();
            myClone.blessing = blessing;
            myClone.MinionUpdateSpeed = MinionUpdateSpeed;
            
            return myClone;
        }

        public override void SetStaticDefaults()
        {
            // Initialize default whip tag if needed
        }

        public override void PostUpdate(Item item)
        {
            // Initialize whip tag if it's null and this item can give tags
            if (CanGiveTag && wTag == null)
            {
                wTag = new WhipTag("default", 0);
            }

            // Prefix効果に基づいてプロパティを更新
            UpdatePrefixEffects(item);
        }

        private void UpdatePrefixEffects(Item item)
        {
            if (item?.IsAir != false) return;

            try
            {
                // Brisk効果: MinionSpeedMultの更新（元のSummonerPrefixの実装）
                if (item.prefix == ModContent.PrefixType<Prefixes.Brisk>())
                {
                    MinionSpeedMult += Prefixes.Brisk.MinionSpeedMult - 1f;
                }
                else if (MinionSpeedMult != 1f && item.prefix != ModContent.PrefixType<Prefixes.Brisk>())
                {
                    // Brisk以外のPrefixの場合はリセット
                    MinionSpeedMult = 1f;
                }
            }
            catch (System.Exception ex)
            {
                TranslateTest2.Instance?.Logger?.Debug($"Error updating prefix effects: {ex.Message}");
            }
        }
    }
}