using Terraria;
using Terraria.ModLoader;

namespace TranslateTest2
{
    public class PrefixGlobalItem : GlobalItem
    {
        public float MinionSlotMult = 1f;
        public float MinionSpeedMult = 1f;
        public float MinionScaleMult = 1f;
        public float MinionKnockbackMult = 1f;
        public float MinionLifeSteal = 0f;
        public float MinionCritAdd = 0f;
        public float MinionUpdateSpeed = 1f;
        public float WhipRangeMult = 1f;
        public bool CanGiveTag = false;
        public WhipTag wTag = null;
        
        // Existing prefix properties
        public bool electrified = false;
        public bool blessing = false; // Blessing prefix property
        
        // New prefix properties
        public bool vengeful = false;
        public bool affable = false;
        public int mega = 0; // Extra minion slots
        public bool steady = false;
        public bool loyal = false;
        public bool oracle = false;

        public override bool InstancePerEntity => true;

        public override GlobalItem Clone(Item from, Item to)
        {
            PrefixGlobalItem myClone = (PrefixGlobalItem)base.Clone(from, to);
            myClone.wTag = wTag?.Clone();
            
            // 新しいPrefix効果もクローンに含める
            myClone.vengeful = vengeful;
            myClone.affable = affable;
            myClone.mega = mega;
            myClone.steady = steady;
            myClone.loyal = loyal;
            myClone.oracle = oracle;
            myClone.blessing = blessing;
            myClone.MinionUpdateSpeed = MinionUpdateSpeed;
            
            return myClone;
        }

        public override void SetStaticDefaults()
        {
            // Initialize default whip tag if needed
        }

        public override void PostUpdate(Item item)
        {
            // Initialize whip tag if it's null and this item can give tags
            if (CanGiveTag && wTag == null)
            {
                wTag = new WhipTag("default", 0);
            }

            // Prefix効果に基づいてプロパティを更新
            UpdatePrefixEffects(item);
        }

        private void UpdatePrefixEffects(Item item)
        {
            if (item?.IsAir != false) return;

            try
            {
                // Brisk効果: MinionUpdateSpeedの更新
                if (item.prefix == ModContent.PrefixType<Prefixes.Brisk>())
                {
                    MinionUpdateSpeed = 1f + Prefixes.Brisk.SpeedIncrease;
                }
                else if (MinionUpdateSpeed != 1f && item.prefix != ModContent.PrefixType<Prefixes.Brisk>())
                {
                    // Brisk以外のPrefixの場合はリセット
                    MinionUpdateSpeed = 1f;
                }

                // 他のPrefix効果は既にApplyで設定されているか、リアルタイムで計算される
            }
            catch (System.Exception ex)
            {
                TranslateTest2.Instance?.Logger?.Debug($"Error updating prefix effects: {ex.Message}");
            }
        }
    }
}